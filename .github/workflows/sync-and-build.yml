name: Sync Fork and Build Docker Image

on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡åŒæ­¥
  schedule:
    - cron: '0 * * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸æ‚¨åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

  # 3. Push è§¦å‘ï¼šå½“æœ‰ä»£ç æ¨é€åˆ° master åˆ†æ”¯æ—¶ï¼Œè§¦å‘æ„å»ºå’Œæ¨é€ä½œä¸š
  push:
    branches:
      - master
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  # ä½œä¸šä¸€ï¼šåŒæ­¥ä¸Šæ¸¸ä»“åº“
  sync_fork:
    runs-on: ubuntu-latest
    # ä»…åœ¨å®šæ—¶æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œæ­¤ä½œä¸š
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦ä¸€ä¸ªæœ‰å†™æƒé™çš„ PAT (Personal Access Token) æ¥æ¨é€æ›´æ–°
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´çš„å†å²è®°å½•

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: å®‰å…¨åŒæ­¥ä¸Šæ¸¸ä»“åº“ (ä¿æŠ¤å…³é”®æ–‡ä»¶å’Œç›®å½•)
        run: |
          echo "ğŸ”„ å¼€å§‹å®‰å…¨åŒæ­¥æµç¨‹..."
          
          # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“
          if ! git remote get-url upstream >/dev/null 2>&1; then
            echo "â• æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“..."
            git remote add upstream https://github.com/su-kaka/gcli2api.git
          fi
          
          # è·å–ä¸Šæ¸¸æ›´æ–°
          echo "ğŸ“¥ è·å–ä¸Šæ¸¸æ›´æ–°..."
          git fetch upstream master
          
          # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æˆ‘ä»¬æœ¬åœ°å°šæœªåˆå¹¶çš„æ–°æäº¤
          NEW_COMMITS_COUNT=$(git rev-list --count HEAD..upstream/master)
          
          if [ "$NEW_COMMITS_COUNT" -eq 0 ]; then
            echo "âœ… ä¸Šæ¸¸æ²¡æœ‰æ–°æäº¤ï¼Œæ— éœ€åŒæ­¥"
            exit 0
          fi
          
          echo "ğŸ” æ£€æµ‹åˆ°ä¸Šæ¸¸æœ‰ $NEW_COMMITS_COUNT ä¸ªæ–°æäº¤ï¼Œå¼€å§‹åŒæ­¥..."
          
          # å¤‡ä»½å…³é”®æ–‡ä»¶å’Œç›®å½•
          echo "ï¸ å¤‡ä»½å…³é”®æ–‡ä»¶å’Œç›®å½•..."
          BACKUP_DIR="/tmp/backup-$(date +%s)"
          mkdir -p $BACKUP_DIR
          
          # å®šä¹‰éœ€è¦ä¿æŠ¤çš„æ–‡ä»¶/ç›®å½•åˆ—è¡¨
          PROTECTED_FILES=(".github" "Dockerfile" "docker-compose.yml" "docker-compose-bridge.yml")
          
          for item in "${PROTECTED_FILES[@]}"; do
            if [ -e "$item" ]; then
              echo "  -> å¤‡ä»½ $item"
              cp -r "$item" "$BACKUP_DIR/"
            else
              echo "  -> $item ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
            fi
          done
          
          # å¼ºåˆ¶é‡ç½®åˆ°ä¸Šæ¸¸åˆ†æ”¯
          echo "ğŸ”„ å°† master åˆ†æ”¯é‡ç½®åˆ° upstream/master..."
          git reset --hard upstream/master
          
          # æ¢å¤å¤‡ä»½çš„æ–‡ä»¶å’Œç›®å½•
          echo " æ¢å¤å…³é”®æ–‡ä»¶å’Œç›®å½•..."
          for item in "${PROTECTED_FILES[@]}"; do
            if [ -e "$BACKUP_DIR/$(basename $item)" ]; then
              echo "  -> æ¢å¤ $item"
              # å…ˆåˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç‰ˆæœ¬ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
              rm -rf "$item"
              # ä»å¤‡ä»½ä¸­æ¢å¤
              cp -r "$BACKUP_DIR/$(basename $item)" .
            fi
          done
          
          # æ¸…ç†å¤‡ä»½ç›®å½•
          rm -rf $BACKUP_DIR
          
          # æäº¤æ›´æ”¹
          echo "ğŸ’¾ æäº¤åŒæ­¥åçš„æ›´æ”¹..."
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æ–‡ä»¶å˜åŠ¨éœ€è¦æäº¤
          git add .
          
          # å¦‚æœ git diff --quiet --cached è¿”å› 0ï¼Œè¯´æ˜æ²¡æœ‰æ–‡ä»¶å˜åŠ¨
          if git diff --quiet --cached; then
            echo "âœ… åŒæ­¥åæ— æ–‡ä»¶å˜åŠ¨ï¼Œæ— éœ€æ¨é€"
            exit 0
          fi
          
          # æäº¤æ›´æ”¹
          echo "ğŸ’¾ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŠ¨ï¼Œæäº¤åŒæ­¥åçš„æ›´æ”¹..."
          git commit -m "chore: åŒæ­¥ä¸Šæ¸¸ä»“åº“å¹¶ä¿æŠ¤å…³é”®æ–‡ä»¶"
          
          # æ¨é€æ›´æ–°
          echo "ğŸš€ æ¨é€æ›´æ–°åˆ°è¿œç¨‹ä»“åº“..."
          git push origin master --force
          
          echo "ğŸ‰ åŒæ­¥å®Œæˆ!"

  # ä½œä¸šäºŒï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  build_and_push:
    runs-on: ubuntu-latest
    # ä»…åœ¨ä»£ç è¢«æ¨é€åˆ° master åˆ†æ”¯æ—¶è¿è¡Œæ­¤ä½œä¸š
    # (åŒæ­¥ä½œä¸šæˆåŠŸåä¼šäº§ç”Ÿä¸€æ¬¡ pushï¼Œä»è€Œè§¦å‘æ­¤ä½œä¸š)
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write # éœ€è¦ 'packages' çš„å†™æƒé™æ¥æ¨é€é•œåƒåˆ° GHCR
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }} # è‡ªåŠ¨è·å–æ‚¨çš„ GitHub ç”¨æˆ·å
          password: ${{ secrets.GITHUB_TOKEN }}   # ä½¿ç”¨ GitHub è‡ªåŠ¨æä¾›çš„ GITHUB_TOKEN

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/gcli2api
          tags: |
            # ä¸ºé•œåƒæ·»åŠ ä¸¤ä¸ªæ ‡ç­¾:
            # 1. å…·ä½“ç‰ˆæœ¬å· (commit SHA)
            type=sha
            # 2. å½“æ¨é€åˆ°é»˜è®¤åˆ†æ”¯ (master) æ—¶ï¼Œæ·»åŠ  'latest' æ ‡ç­¾
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
